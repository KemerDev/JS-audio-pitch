<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>pitch detection</title>
    <link rel="stylesheet" href="style.css">
  </head>
  <body>
    <audio id="capture"></audio>
    <div class="contain">
      <div id="text" class="main-text">
      </div>
    </div>
  </body>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"
        integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU="crossorigin="anonymous">
  </script>

  <script>
    const cap = document.getElementById('capture');

    const handleSuccess = function(stream) {
      const text = document.getElementById('text');

      var context = new AudioContext();

      var source = context.createMediaStreamSource(stream);
      var processor = context.createScriptProcessor(4096, 1, 1);

      var biquadFilter = context.createBiquadFilter();
      biquadFilter.type = "lowpass";
      biquadFilter.frequency.value = 1800;

      var analyser = context.createAnalyser();

      biquadFilter.connect(analyser);
      context.connect(biquadFilter);

      var buffer = [];

      source.connect(processor);
      processor.connect(context.destination);

      processor.onaudioprocess = function(e) {

        if(e.inputBuffer.getChannelData(0)[0] > 0.001 || e.inputBuffer.getChannelData(0)[0] < -0.001) {
          create_buff(e.inputBuffer.getChannelData(0), e.inputBuffer.length);
        } else {
          text.innerHTML = 0 + " hz";
        }

        if(buffer.length === 40960) {
          pitch_calc(buffer, buffer.length, e.inputBuffer.sampleRate);
          buffer.length = 0;
        }
      };


    //fill a big buffer, the bigger the buffer the more accurate the detection

    function create_buff(samples, size) {

      for (var i = 0; i < size; i++) {
        buffer.push(samples[i]);
      }

      return buffer;
    }

    //function for pitch detection using zero crossing

    function pitch_calc(samples, size, sample_rate) {
      var cross = 0;
      var cycles;
      var frequency = 0;
      var epoch;

      for(var i = 0; i < size - 1; i++) {
        if((samples[i] > 0 && samples[i + 1] <= 0) || (samples[i] < 0 && samples[i + 1] >= 0)) {
          cross++;
        }
      }

      epoch = size / sample_rate;
      cycles = cross / 2;
      frequency = cycles / epoch;


      console.log(Number(frequency).toFixed(1));

      text.innerHTML = Number(frequency).toFixed(1);

      /*$.getJSON("notes.json", function(data) {
        $(document).ready(function() {
          for(x in data.notes) {
            if(Number(frequency).toFixed(1) == data.notes[x]) {
              text.innerHTML = x +' '+ frequency;
            } else {
              text.innerHTML = 0 + 'HZ';
            }
          }
        });
      });*/
    }
  };

    navigator.mediaDevices.getUserMedia({ audio: true, video: false})
      .then(handleSuccess);
  </script>

</html>
